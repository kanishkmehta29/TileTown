<!DOCTYPE html>
<html>
<head>
    <title>TileTown Office</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial; background: #2c3e50; }
        #gameContainer { text-align: center; }
        #info { margin-bottom: 10px; color: white; }
        #joinForm { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            display: inline-block; 
            margin-bottom: 20px; 
        }
        input, button { padding: 8px; margin: 5px; }
        button { background: #3498db; color: white; border: none; cursor: pointer; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="joinForm">
            <h3>Join TileTown Office</h3>
            <input type="text" id="roomCode" placeholder="Room Code" />
            <input type="text" id="playerName" placeholder="Your Name" />
            <button onclick="joinRoom()">Join Room</button>
        </div>
        <div id="info" style="display: none;">
            Use Arrow Keys to move around the office
        </div>
    </div>

    <script>
        let game = null;
        let ws = null;

        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!roomCode || !playerName) {
                alert('Please enter both room code and your name');
                return;
            }
            
            document.getElementById('joinForm').style.display = 'none';
            document.getElementById('info').style.display = 'block';
            startGame(roomCode, playerName);
        }

        function startGame(roomCode, playerName) {
            class OfficeScene extends Phaser.Scene {
                constructor() {
                    super({ key: 'OfficeScene' });
                    this.players = new Map();
                    this.myPlayer = null;
                    this.lastMoveTime = 0;
                    this.moveDelay = 200;
                    this.roomCode = roomCode;
                    this.playerName = playerName;
                }

                preload() {
                    this.createTextures();
                }

                create() {
                    this.createOfficeLayout();
                    this.setupWebSocket();
                    this.setupInput();
                    this.createUI();
                }

                createTextures() {
                    // Enhanced floor tile with office carpet pattern
                    this.add.graphics()
                        .fillStyle(0xe8e8e8)
                        .fillRect(0, 0, 32, 32)
                        .lineStyle(1, 0xd0d0d0)
                        .strokeRect(0, 0, 32, 32)
                        .fillStyle(0xdcdcdc)
                        .fillRect(2, 2, 28, 28)
                        .lineStyle(0.5, 0xc0c0c0)
                        .beginPath()
                        .moveTo(8, 8)
                        .lineTo(24, 8)
                        .moveTo(8, 16)
                        .lineTo(24, 16)
                        .moveTo(8, 24)
                        .lineTo(24, 24)
                        .strokePath()
                        .generateTexture('floor', 32, 32)
                        .destroy();

                    // Modern office wall
                    this.add.graphics()
                        .fillStyle(0x34495e)
                        .fillRect(0, 0, 32, 32)
                        .lineStyle(2, 0x2c3e50)
                        .strokeRect(0, 0, 32, 32)
                        .fillStyle(0x3d566e)
                        .fillRect(4, 4, 24, 24)
                        .generateTexture('wall', 32, 32)
                        .destroy();

                    // Modern desk with details
                    this.add.graphics()
                        .fillStyle(0x8B4513)
                        .fillRect(0, 0, 32, 32)
                        .fillStyle(0xDEB887)
                        .fillRect(2, 2, 28, 28)
                        .lineStyle(1, 0x8B4513)
                        .strokeRect(2, 2, 28, 28)
                        .fillStyle(0x696969)
                        .fillRect(4, 4, 6, 6)
                        .fillRect(22, 4, 6, 6)
                        .fillStyle(0x2F4F4F)
                        .fillRect(12, 12, 8, 6)
                        .generateTexture('desk', 32, 32)
                        .destroy();

                    // Office chair with back and armrests
                    this.add.graphics()
                        .fillStyle(0x2F4F4F)
                        .fillRect(8, 4, 16, 20)
                        .fillStyle(0x696969)
                        .fillRect(10, 6, 12, 16)
                        .fillRect(6, 8, 4, 8)
                        .fillRect(22, 8, 4, 8)
                        .fillRect(12, 22, 8, 6)
                        .generateTexture('chair', 32, 32)
                        .destroy();

                    // Meeting room with table
                    this.add.graphics()
                        .fillStyle(0xF0F8FF)
                        .fillRect(0, 0, 32, 32)
                        .lineStyle(2, 0x4169E1)
                        .strokeRect(0, 0, 32, 32)
                        .fillStyle(0x8B4513)
                        .fillRect(6, 12, 20, 8)
                        .generateTexture('meeting', 32, 32)
                        .destroy();

                    // Printer/Office equipment
                    this.add.graphics()
                        .fillStyle(0xF5F5F5)
                        .fillRect(4, 4, 24, 24)
                        .lineStyle(1, 0x696969)
                        .strokeRect(4, 4, 24, 24)
                        .fillStyle(0x2F4F4F)
                        .fillRect(8, 8, 16, 4)
                        .fillStyle(0x228B22)
                        .fillCircle(26, 8, 2)
                        .generateTexture('printer', 32, 32)
                        .destroy();

                    // Water cooler
                    this.add.graphics()
                        .fillStyle(0x4682B4)
                        .fillRect(12, 4, 8, 24)
                        .fillStyle(0x87CEEB)
                        .fillRect(14, 6, 4, 8)
                        .fillStyle(0xC0C0C0)
                        .fillRect(10, 20, 12, 8)
                        .generateTexture('watercooler', 32, 32)
                        .destroy();

                    // Plant decoration
                    this.add.graphics()
                        .fillStyle(0x8B4513)
                        .fillRect(12, 24, 8, 8)
                        .fillStyle(0x228B22)
                        .fillCircle(16, 16, 12)
                        .fillStyle(0x32CD32)
                        .fillCircle(12, 12, 6)
                        .fillCircle(20, 12, 6)
                        .fillCircle(16, 8, 4)
                        .generateTexture('plant', 32, 32)
                        .destroy();

                    // Human player sprites with direction
                    this.createHumanSprites();
                }

                createHumanSprites() {
                    const colors = [
                        { body: 0xFF6B6B, shirt: 0x4ECDC4 }, // Red/Teal
                        { body: 0x6B6BFF, shirt: 0xFFE66D }, // Blue/Yellow
                        { body: 0x95E1D3, shirt: 0xF38BA8 }, // Green/Pink
                        { body: 0xFFAB91, shirt: 0x81C784 }, // Orange/Green
                    ];

                    // Create sprites for each direction and player type
                    ['player', 'otherPlayer'].forEach((playerType, typeIndex) => {
                        const colorSet = colors[typeIndex % colors.length];
                        
                        ['down', 'up', 'left', 'right'].forEach(direction => {
                            const graphics = this.add.graphics();
                            
                            // Body (circle)
                            graphics.fillStyle(colorSet.body);
                            graphics.fillCircle(16, 20, 8);
                            
                            // Head
                            graphics.fillStyle(0xFFDBAE);
                            graphics.fillCircle(16, 10, 6);
                            
                            // Shirt/clothes
                            graphics.fillStyle(colorSet.shirt);
                            graphics.fillRect(12, 16, 8, 8);
                            
                            // Eyes based on direction
                            graphics.fillStyle(0x000000);
                            switch(direction) {
                                case 'down':
                                    graphics.fillCircle(14, 9, 1);
                                    graphics.fillCircle(18, 9, 1);
                                    break;
                                case 'up':
                                    graphics.fillCircle(14, 7, 1);
                                    graphics.fillCircle(18, 7, 1);
                                    break;
                                case 'left':
                                    graphics.fillCircle(13, 8, 1);
                                    graphics.fillCircle(15, 9, 1);
                                    break;
                                case 'right':
                                    graphics.fillCircle(17, 9, 1);
                                    graphics.fillCircle(19, 8, 1);
                                    break;
                            }
                            
                            // Arms based on direction
                            graphics.fillStyle(colorSet.shirt);
                            switch(direction) {
                                case 'down':
                                case 'up':
                                    graphics.fillRect(8, 18, 3, 6);  // Left arm
                                    graphics.fillRect(21, 18, 3, 6); // Right arm
                                    break;
                                case 'left':
                                    graphics.fillRect(6, 18, 6, 3);  // Extended left arm
                                    graphics.fillRect(20, 18, 4, 4); // Right arm
                                    break;
                                case 'right':
                                    graphics.fillRect(8, 18, 4, 4);  // Left arm
                                    graphics.fillRect(20, 18, 6, 3); // Extended right arm
                                    break;
                            }
                            
                            graphics.generateTexture(`${playerType}_${direction}`, 32, 32);
                            graphics.destroy();
                        });
                    });
                }

                createOfficeLayout() {
                    const TILE_SIZE = 32;
                    this.officeWidth = 25;
                    this.officeHeight = 18;
                    
                    // Create floor
                    for (let x = 0; x < this.officeWidth; x++) {
                        for (let y = 0; y < this.officeHeight; y++) {
                            this.add.image(x * TILE_SIZE + 16, y * TILE_SIZE + 16, 'floor');
                        }
                    }

                    // Create walls (borders)
                    for (let x = 0; x < this.officeWidth; x++) {
                        this.add.image(x * TILE_SIZE + 16, 16, 'wall');
                        this.add.image(x * TILE_SIZE + 16, (this.officeHeight - 1) * TILE_SIZE + 16, 'wall');
                    }
                    for (let y = 0; y < this.officeHeight; y++) {
                        this.add.image(16, y * TILE_SIZE + 16, 'wall');
                        this.add.image((this.officeWidth - 1) * TILE_SIZE + 16, y * TILE_SIZE + 16, 'wall');
                    }

                    // Workstation areas
                    const workstations = [
                        { desk: [3, 3], chair: [3, 4] },
                        { desk: [3, 7], chair: [3, 8] },
                        { desk: [3, 11], chair: [3, 12] },
                        { desk: [8, 3], chair: [8, 4] },
                        { desk: [8, 7], chair: [8, 8] },
                        { desk: [8, 11], chair: [8, 12] },
                        { desk: [13, 3], chair: [13, 4] },
                        { desk: [13, 7], chair: [13, 8] },
                        { desk: [13, 11], chair: [13, 12] },
                    ];

                    workstations.forEach(station => {
                        this.add.image(station.desk[0] * TILE_SIZE + 16, station.desk[1] * TILE_SIZE + 16, 'desk');
                        this.add.image(station.chair[0] * TILE_SIZE + 16, station.chair[1] * TILE_SIZE + 16, 'chair');
                    });

                    // Meeting room
                    for (let x = 18; x < 23; x++) {
                        for (let y = 3; y < 8; y++) {
                            this.add.image(x * TILE_SIZE + 16, y * TILE_SIZE + 16, 'meeting');
                        }
                    }

                    // Office equipment
                    this.add.image(16 * TILE_SIZE + 16, 3 * TILE_SIZE + 16, 'printer');
                    this.add.image(16 * TILE_SIZE + 16, 11 * TILE_SIZE + 16, 'watercooler');
                    
                    // Plants for decoration
                    this.add.image(6 * TILE_SIZE + 16, 2 * TILE_SIZE + 16, 'plant');
                    this.add.image(11 * TILE_SIZE + 16, 2 * TILE_SIZE + 16, 'plant');
                    this.add.image(6 * TILE_SIZE + 16, 15 * TILE_SIZE + 16, 'plant');
                    this.add.image(11 * TILE_SIZE + 16, 15 * TILE_SIZE + 16, 'plant');

                    // Store collision objects
                    this.obstacles = new Set();
                    workstations.forEach(station => {
                        this.obstacles.add(`${station.desk[0]},${station.desk[1]}`);
                        this.obstacles.add(`${station.chair[0]},${station.chair[1]}`);
                    });
                    
                    // Add meeting room obstacles
                    for (let x = 18; x < 23; x++) {
                        for (let y = 3; y < 8; y++) {
                            if (x === 20 && y === 5) continue; // Center table, allow walking
                            this.obstacles.add(`${x},${y}`);
                        }
                    }
                    
                    // Add equipment obstacles
                    this.obstacles.add('16,3');
                    this.obstacles.add('16,11');
                    this.obstacles.add('6,2');
                    this.obstacles.add('11,2');
                    this.obstacles.add('6,15');
                    this.obstacles.add('11,15');
                }

                setupWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.host;
                    ws = new WebSocket(`${protocol}//${host}/rooms/${this.roomCode}/join/${this.playerName}`);
                    
                    ws.onopen = () => {
                        console.log('Connected to TileTown server');
                        this.connectionStatus.setText('Connected').setStyle({ color: '#00ff00' });
                    };
                    
                    ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleServerMessage(message);
                    };
                    
                    ws.onclose = () => {
                        console.log('Disconnected from server');
                        this.connectionStatus.setText('Disconnected').setStyle({ color: '#ff0000' });
                    };
                    
                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.connectionStatus.setText('Connection Error').setStyle({ color: '#ff0000' });
                    };
                }

                setupInput() {
                    this.cursors = this.input.keyboard.createCursorKeys();
                    this.wasd = this.input.keyboard.addKeys('W,S,A,D');
                }

                createUI() {
                    this.connectionStatus = this.add.text(10, 10, 'Connecting...', {
                        fontSize: '16px',
                        color: '#ffff00'
                    }).setScrollFactor(0);
                    
                    this.playerCount = this.add.text(10, 35, 'Players: 0', {
                        fontSize: '14px',
                        color: '#ffffff'
                    }).setScrollFactor(0);
                    
                    this.add.text(10, this.cameras.main.height - 40, 'WASD or Arrow Keys to move', {
                        fontSize: '12px',
                        color: '#cccccc'
                    }).setScrollFactor(0);
                }

                update(time) {
                    if (time - this.lastMoveTime > this.moveDelay) {
                        if (this.cursors.left.isDown || this.wasd.A.isDown) {
                            this.movePlayer(-1, 0, 'left');
                            this.lastMoveTime = time;
                        } else if (this.cursors.right.isDown || this.wasd.D.isDown) {
                            this.movePlayer(1, 0, 'right');
                            this.lastMoveTime = time;
                        } else if (this.cursors.up.isDown || this.wasd.W.isDown) {
                            this.movePlayer(0, -1, 'up');
                            this.lastMoveTime = time;
                        } else if (this.cursors.down.isDown || this.wasd.S.isDown) {
                            this.movePlayer(0, 1, 'down');
                            this.lastMoveTime = time;
                        }
                    }
                }

                movePlayer(deltaX, deltaY, direction) {
                    if (!this.myPlayer) return;

                    const newX = this.myPlayer.tileX + deltaX;
                    const newY = this.myPlayer.tileY + deltaY;

                    if (this.isValidPosition(newX, newY)) {
                        this.myPlayer.tileX = newX;
                        this.myPlayer.tileY = newY;
                        this.myPlayer.direction = direction;

                        // Update sprite texture based on direction
                        this.myPlayer.sprite.setTexture(`player_${direction}`);

                        // Walking animation effect
                        this.tweens.add({
                            targets: this.myPlayer.sprite,
                            scaleY: 0.95,
                            duration: 100,
                            yoyo: true,
                            ease: 'Power2'
                        });

                        // Move sprite and name
                        this.tweens.add({
                            targets: [this.myPlayer.sprite, this.myPlayer.nameText],
                            x: newX * 32 + 16,
                            y: [newY * 32 + 16, newY * 32 - 10],
                            duration: 150,
                            ease: 'Power2'
                        });

                        // Send movement to server
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'move',
                                id: this.myPlayer.id,
                                x: newX,
                                y: newY,
                                direction: direction
                            }));
                        }
                    }
                }

                isValidPosition(x, y) {
                    if (x <= 0 || y <= 0 || x >= this.officeWidth - 1 || y >= this.officeHeight - 1) {
                        return false;
                    }

                    if (this.obstacles.has(`${x},${y}`)) {
                        return false;
                    }

                    for (let [id, player] of this.players) {
                        if (player.tileX === x && player.tileY === y && id !== this.myPlayer?.id) {
                            return false;
                        }
                    }

                    return true;
                }

                handleServerMessage(message) {
                    console.log('Received message:', message);

                    switch(message.type) {
                        case 'welcome':
                            this.addPlayer(message.id, this.playerName, message.x, message.y, true);
                            break;

                        case 'playerJoined':
                            if (message.id !== this.myPlayer?.id) {
                                this.addPlayer(message.id, message.text || 'Player', message.x, message.y, false);
                            }
                            break;

                        case 'move':
                            if (!this.players.has(message.id)) {
                                this.addPlayer(message.id, 'Player', message.x, message.y, false);
                            }
                            this.updatePlayerPosition(message.id, message.x, message.y, message.direction);
                            break;

                        case 'playerLeft':
                            this.removePlayer(message.id);
                            break;
                    }

                    this.updatePlayerCount();
                }

                addPlayer(id, name, x, y, isMe = false) {
                    if (this.players.has(id)) return;

                    const sprite = this.add.image(
                        x * 32 + 16,
                        y * 32 + 16,
                        `${isMe ? 'player' : 'otherPlayer'}_down`
                    );
                    sprite.setDepth(10);

                    const nameText = this.add.text(x * 32 + 16, y * 32 - 10, name, {
                        fontSize: '10px',
                        color: '#000000',
                        backgroundColor: '#ffffff',
                        padding: { x: 3, y: 2 },
                        borderRadius: 3
                    }).setOrigin(0.5, 1).setDepth(11);

                    const player = {
                        id,
                        name,
                        tileX: x,
                        tileY: y,
                        direction: 'down',
                        sprite,
                        nameText
                    };

                    this.players.set(id, player);

                    if (isMe) {
                        this.myPlayer = player;
                        console.log(`My player created at position: (${x}, ${y})`);
                    }
                }

                updatePlayerPosition(id, x, y, direction = 'down') {
                    let player = this.players.get(id);

                    if (!player) {
                        this.addPlayer(id, 'Player', x, y, false);
                        player = this.players.get(id);
                    }

                    if (!player) return;

                    player.tileX = x;
                    player.tileY = y;
                    player.direction = direction;

                    // Update sprite direction
                    player.sprite.setTexture(`otherPlayer_${direction}`);

                    // Walking animation
                    this.tweens.add({
                        targets: player.sprite,
                        scaleY: 0.95,
                        duration: 100,
                        yoyo: true,
                        ease: 'Power2'
                    });

                    // Move animation
                    this.tweens.add({
                        targets: [player.sprite, player.nameText],
                        x: x * 32 + 16,
                        y: [y * 32 + 16, y * 32 - 10],
                        duration: 180,
                        ease: 'Power2'
                    });
                }

                removePlayer(id) {
                    const player = this.players.get(id);
                    if (!player) return;

                    player.sprite.destroy();
                    player.nameText.destroy();
                    this.players.delete(id);

                    if (this.myPlayer && this.myPlayer.id === id) {
                        this.myPlayer = null;
                    }

                    console.log(`Player ${player.name} left`);
                }

                updatePlayerCount() {
                    this.playerCount.setText(`Players: ${this.players.size}`);
                }
            }

            const config = {
                type: Phaser.AUTO,
                width: 800,
                height: 576,
                parent: 'gameContainer',
                backgroundColor: '#34495e',
                scene: OfficeScene,
                scale: {
                    mode: Phaser.Scale.FIT,
                    autoCenter: Phaser.Scale.CENTER_BOTH
                }
            };

            game = new Phaser.Game(config);
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden && ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>